<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campus Energy Dashboard</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .metric-container { display: flex; flex-wrap: wrap; }
        .metric { border: 1px solid #ccc; padding: 15px; margin: 10px; border-radius: 5px; text-align: center; flex-grow: 1; min-width: 250px; }
        .metric h2 { margin: 0 0 10px 0; font-size: 1.2em; color: #555; }
        .metric .value { font-size: 2.5em; font-weight: bold; color: #007bff; }
        .metric .label { font-size: 0.9em; color: #888; }
        #loading_campus, #loading_building { color: gray; font-style: italic; }
        #error_campus, #error_building { color: red; font-weight: bold; }
    </style>
</head>
<body>

    <h1>âš¡ Campus Energy Dashboard</h1>
    <p><i>Live data for PES University campus energy consumption.</i></p>
    <hr>

    <div id="loading_campus">Loading campus data...</div>
    <div id="error_campus" style="display: none;"></div>

    <div class="metric-container">
    
        <div class="metric" id="campus-metric" style="display: none;">
            <h2>Campus Overview (Today)</h2>
            <div class="value" id="campus-total">- kWh</div>
            <div class="label">Last Reading: <span id="campus-last-updated">-</span></div>
        </div>

        <div class="metric" id="building-metric" style="display: none;">
            <h2>ECE Building (Today)</h2>
            <div class="value" id="building-total">- kWh</div>
            <div class="label">Last Reading: <span id="building-last-updated">-</span></div>
        </div>

    </div>
    
    <div id="loading_building" style="margin-top: 10px;"></div>
    <div id="error_building" style="display: none;"></div>


    <script>
    // --- Element Selectors ---
    const campusTotalElement = document.getElementById('campus-total');
    const campusLastUpdatedElement = document.getElementById('campus-last-updated');
    const loadingCampusElement = document.getElementById('loading_campus');
    const errorCampusElement = document.getElementById('error_campus');
    const campusMetricElement = document.getElementById('campus-metric');

    const buildingTotalElement = document.getElementById('building-total');
    const buildingLastUpdatedElement = document.getElementById('building-last-updated');
    const loadingBuildingElement = document.getElementById('loading_building');
    const errorBuildingElement = document.getElementById('error_building');
    const buildingMetricElement = document.getElementById('building-metric');

    const API_BASE_URL = ''; 

    function getTodayDateString() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // --- Function to fetch CAMPUS data ---
    async function fetchCampusData() {
        const todayStr = getTodayDateString();
        
        // ðŸ’¡ --- CACHE-BUSTING FIX ---
        // We add a 'cache_bust' parameter with the current time.
        // This forces the server/browser to fetch a fresh result.
        const cacheBust = new Date().getTime();
        const apiUrl = `${API_BASE_URL}/api/aggregate/campus?start_date=${todayStr}&end_date=${todayStr}&cache_bust=${cacheBust}`;
        // ðŸ’¡ --- END OF FIX ---

        loadingCampusElement.style.display = 'block';
        errorCampusElement.style.display = 'none';
        campusMetricElement.style.display = 'none';

        try {
            const response = await fetch(apiUrl);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API Error (${response.status}): ${errorData.error || 'Unknown error'}`);
            }
            const data = await response.json();

            campusTotalElement.textContent = `${data.total_energy_kwh.toFixed(2)} kWh`;
            campusLastUpdatedElement.textContent = data.last_reading_in_range || 'N/A';
            campusMetricElement.style.display = 'block';

        } catch (error) {
            console.error('Failed to fetch campus data:', error);
            errorCampusElement.textContent = `Error loading campus data: ${error.message}`;
            errorCampusElement.style.display = 'block';
        } finally {
            loadingCampusElement.style.display = 'none';
        }
    }

    // --- Function to fetch BUILDING data ---
    async function fetchBuildingData() {
        const todayStr = getTodayDateString();
        
        // ðŸ’¡ --- CACHE-BUSTING FIX ---
        const cacheBust = new Date().getTime();
        const apiUrl = `${API_BASE_URL}/api/aggregate/building/ECE?start_date=${todayStr}&end_date=${todayStr}&cache_bust=${cacheBust}`;
        // ðŸ’¡ --- END OF FIX ---

        loadingBuildingElement.style.display = 'block';
        errorBuildingElement.style.display = 'none';
        buildingMetricElement.style.display = 'none';

        try {
            const response = await fetch(apiUrl);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API Error (${response.status}): ${errorData.error || 'Unknown error'}`);
            }
            const data = await response.json();

            buildingTotalElement.textContent = `${data.total_energy_kwh.toFixed(2)} kWh`;
            buildingLastUpdatedElement.textContent = data.last_reading_in_range || 'N/A';
            buildingMetricElement.style.display = 'block';

        } catch (error) {
            console.error('Failed to fetch building data:', error);
            errorBuildingElement.textContent = `Error loading ECE data: ${error.message}`;
            errorBuildingElement.style.display = 'block';
        } finally {
            loadingBuildingElement.style.display = 'none';
        }
    }

    // --- Auto-Refresh Logic ---
    function fetchAllData() {
        fetchCampusData();
        fetchBuildingData();
    }

    // Fetch data immediately when the page loads
    fetchAllData();

    // Then, fetch data every 30 seconds
    setInterval(fetchAllData, 30000); // 30000 milliseconds = 30 seconds
    
    </script>
</body>
</html>
